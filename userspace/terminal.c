#include "terminal.h"

#include "driver/keyboard.h"
#include "driver/screen.h"
#include "osdev/input/keyboard.h"

#include "kstdlib.h"
/* key map from keycode to ASCII character */
static char keymap[256] = {
/* 00 */    0,   0, '1', '2', '3', '4', '5', '6',
/* 08 */  '7', '8', '9', '0', '-', '=', '\b',  0,
/* 10 */  'q', 'w', 'e', 'r', 't', 'y', 'u', 'i',
/* 18 */  'o', 'p', '[', ']', '\n',  0, 'a', 's',
/* 20 */  'd', 'f', 'g', 'h', 'j', 'k', 'l', ';',
/* 28 */  '\'','`',   0, '\\','z', 'x', 'c', 'v',
/* 30 */  'b', 'n', 'm', ',', '.', '/',   0,   0, 
/* 38 */    0, ' ',   0,   0,   0,   0,   0,   0,
/* 40 */    0,   0,   0,   0,   0,   0,   0,   7,
/* 48 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 50 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 58 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 60 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 68 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 70 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 78 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 80 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 88 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 90 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 98 */  0, 0,  0,  0,  0,  0, 0,  0,
/* a0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* a8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* b0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* b8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* c0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* c8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* d0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* d8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* e0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* e8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* f0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* f8 */  0, 0,  0,  0,  0,  0, 0,  0};

static char keymap_cap[256] = {
/* 00 */    0,   0, '!', '@', '#', '$', '%', '^',
/* 08 */  '&', '*', '(', ')', '_', '+',   0,   0,
/* 10 */  'Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I',
/* 18 */  'O', 'P', '{', '}', '\n',  0, 'A', 'S',
/* 20 */  'D', 'F', 'G', 'H', 'J', 'K', 'L', ':',
/* 28 */  '"', '~',   0, '|', 'Z', 'X', 'C', 'V',
/* 30 */  'B', 'N', 'M', '<', '>', '?',   0,   0, 
/* 38 */    0, ' ',   0,   0,   0,   0,   0,   0,
/* 40 */    0,   0,   0,   0,   0,   0,   0,   7,
/* 48 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 50 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 58 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 60 */    0,   0,   0,   0,   0,   0,   0,   0,
/* 68 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 70 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 78 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 80 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 88 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 90 */  0, 0,  0,  0,  0,  0, 0,  0,
/* 98 */  0, 0,  0,  0,  0,  0, 0,  0,
/* a0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* a8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* b0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* b8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* c0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* c8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* d0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* d8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* e0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* e8 */  0, 0,  0,  0,  0,  0, 0,  0,
/* f0 */  0, 0,  0,  0,  0,  0, 0,  0,
/* f8 */  0, 0,  0,  0,  0,  0, 0,  0};

static void keyboard_handler(key_event_t event)
{
    char ch = 0;
    if (event.modifiers & 
        (KEY_MOD_LSHIFT | KEY_MOD_RSHIFT | KEY_MOD_CAPSLOCK))
        ch = keymap_cap[event.keycode];
    else
        ch = keymap[event.keycode];

    if (ch != 0 && event.action == KEY_ACT_DOWN)
        putchar(ch);
        // kprintf("code: %d modifier: %02x action: %d ch: %c\n", 
        //     event.keycode, event.modifiers, event.action, ch);
    // else
        // kprintf("code: %d modifier: %02x action: %d\n", 
        //     event.keycode, event.modifiers, event.action);
}

void term_init()
{
    keyboard_register(keyboard_handler);
}